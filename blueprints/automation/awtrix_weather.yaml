---
blueprint:
  name: AAAWTRIX Weather
  description: >
    This is a blueprint to display the temperature using the default Meteorologisk institutt (Met.no) weather integration. It may work with other weather integrations.

    This blueprint will publish to one topic for the temperature app.  It is called `awtrix_temperature` by default.

    _This blueprint may be updated with new features_

  domain: automation
  input:
    required_sensors:
      name: Required Devices and Sensors
      description: >
        The devices and sensors required for the blueprint to work.
      input:
        awtrix_device_input:
          name: AWTRIX Device (Required)
          description: Select the Awtrix device
          selector:
            device:
              filter:
                integration: mqtt
                manufacturer: Blueforcer
                model: AWTRIX 3
              multiple: true

        hourly_forecast_service_input:
          name: Hourly Forecast Provider (Required)
          description: >
              Select a weather entity that provides hourly forecasts

              This has been tested with the following weather service providers:

              - HA [Meteorologisk institutt (Met.no)](https://www.home-assistant.io/integrations/met) integration 
          
          selector:
            entity:
              filter:
                domain:
                - weather
              multiple: false

        daily_forecast_service_input:
          name: Daily Forecast Provider (Optional)
          description: >
              Select a weather entity that provides daily forecasts

              This has been tested with the following weather service providers:

              - None 
          
          selector:
            entity:
              filter:
                domain:
                - weather
              multiple: false
          default: None

        current_temp_sensor_input:
          name: Outdoor Temperature Sensor (Optional)
          description: >
            If desired, select an optional sensor to provide the current outdoor temperature you wish to display.  This can be a "Feels Like" value or a personal outdoor thermometer.
              -  `None` will use the default temperature provided by the weather service provider selected above.
          selector:
              entity:
                filter:
                  domain: sensor
                multiple: false
          default: None

    awtrix_app_input:
      name: Awtrix App Name
      description: >
        The app name that will be used on the Awtrix device
      selector:
        text:
      default: "awtrix_weather"

    display_duration_input:
      name: Display Duration
      description: >-
        The number of seconds the `AWTRIX Temperature` app should be displayed.  *If you select `0` it will use the Global App Time*
      selector:
        number:
          min: 0
          max: 300
          unit_of_measurement: "sec"
      default: 0

    trigger_frequency_input:
      name: Trigger Frequency
      description: >
        The frequency (in minutes) that automation will use to trigger the refresh of information displayed on the Awrix device.
        This uses the [time pattern trigger](https://www.home-assistant.io/docs/automation/trigger/#time-pattern-trigger) format used by Home Assistant triggers.
      default: "/2"
      selector:
        text:


    hours_displayed_input:
      name: Hours Displayed
      description: >
        The number of hours of temperature forecast displayed along the bottom of the screen
      selector:
        number:
          max: 24
          min: 0
          unit_of_measurement: "hours"
          mode: box
      default: 12

    temp_decimals_input:
      name: Temp Digits
      description: >
        By default the temp is rounded to the nearest whole-number. Change this to 1 or 2 in order to see more decimal places.
      selector:
        number:
          min: 0
          max: 2
          step: 1
          mode: box
          unit_of_measurement: "Decimal places"
      default: 0

    temp_suffix_input:
      name: Temperature suffix
      description: >-
        The suffix to be displayed after the temperature
      selector:
        select:
          options:
            - label: None
              value: ""
            - label: "°"
              value: "°"
            - label: °F
              value: "°F"
            - label: °C
              value: "°C"
            - label: F
              value: "F"
            - label: C
              value: "C"
      default: "°F"

    color_matrix_json_input:
      name: Color Matrix
      description: >
        The `Color Matrix` will control color maps to temperature ranges on the display. The format of this map is **JSON** 

        Some possible mappings are:

        #### USA: Farenheit 0-100


            {"0": "#FEC4FF","10": "#D977DF","20": "#9545BC","30": "#4B379C","40": "#31B8DB","50": "#31DB8B","60": "#6ED228","70": "#FFFF28","80": "#F87E27","90": "#CF3927","100": "#A12527"}


        #### EURO: -12°c to  -38°c

            {"-12": "#D977DF","-6": "#9545BC","-1": "#4B379C","0": "#FEC4FF","4": "#31B8DB","10": "#31DB8B","15": "#6ED228","21": "#FFFF28","27": "#F87E27","32": "#CF3927","38": "#A12527"}

      selector:
        text:
          multiline: true
      default: >
        {
          "0": "#4B0082",
          "10": "#0000FF",
          "20": "#1E90FF",
          "30": "#3DAEF5",
          "40": "#5CCD8E",
          "50": "#32CD32",
          "60": "#FFFF00",
          "70": "#DAA520",
          "80": "#FFA500",
          "90": "#FF4500",
          "100": "#FF0000"
        }

    icon_clear_night_input:
      name: Icon for clear-night
      description: >

        The default clear_night icon is: 

          ![](https://developer.lametric.com/content/apps/icon_thumbs/53383_icon_thumb.gif?v=2) - `53383`

      selector:
        text:
      default: "w-clear-night"

    icon_cloudy_input:
      name: Icon for cloudy
      description: >
        This is the icon ID which maps to the weather state: `cloudy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/53384_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-cloudy"
    icon_exceptional_input:
      name: Icon for exceptional
      description: >
        This is the icon ID which maps to the weather state: `exceptional`


        ![](https://developer.lametric.com/content/apps/icon_thumbs/36637_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-exceptional"
    icon_fog_input:
      name: Icon for fog
      description: >
        This is the icon ID which maps to the weather state: `fog`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/17055_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-fog"
    icon_hail_input:
      name: Icon for hail
      description: >
        This is the icon ID which maps to the weather state: `hail` (IF YOU HAVE A BETTER ONE PLEASE LET ME KNOW)

        ![](https://developer.lametric.com/content/apps/icon_thumbs/53385_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-hail"
    icon_lightning_input:
      name: Icon for lightning
      description: >
        This is the icon ID which maps to the weather state: `lightning`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/29839_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-lightning"
    icon_lightning_rainy_input:
      name: Icon for lightning-rainy
      description: >
        This is the icon ID which maps to the weather state: `lightning-rainy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/49299_icon_thumb.gif?v=4)
      selector:
        text:
      default: "w-lightning-rainy"
    icon_partlycloudy_input:
      name: Icon for partlycloudy
      description: >
        This is the icon ID which maps to the weather state: `partlycloudy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/2286_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-partlycloudy"
    icon_pouring_input:
      name: Icon for pouring
      description: >
        This is the default icon which maps to the weather state: `pouring`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/49300_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-pouring"
    icon_rainy_input:
      name: Icon for rainy
      description: >
        This is the default icon which maps to the weather state: `rainy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/2720_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-rainy"
    icon_snowy_input:
      name: Icon for snowy
      description: >
        This is the icon ID which maps to the weather state: `snowy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/2289_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-snowy"
    icon_snowy_rainy_input:
      name: Icon for snowy-rainy
      description: >
        This is the icon ID which maps to the weather state: `snowy-rainy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/49301_icon_thumb.gif?v=2)
      selector:
        text:
      default: "w-snowy-rainy"
    icon_sunny_input:
      name: Icon for sunny
      description: >
        This is the icon ID which maps to the weather state: `sunny`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/53386_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-sunny"
    icon_windy_input:
      name: Icon for windy
      description: >
        This is the icon ID which maps to the weather state: `windy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/3363_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-windy"
    icon_windy_variant_input:
      name: Icon for windy-variant
      description: >
        This is the icon ID which maps to the weather state: `windy-variant`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/3363_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-windy-variant"

mode: restart
variables:
  device_ids: !input awtrix_device_input
  app_topic: !input awtrix_app_input
  topics: >-
    {%- macro get_device_topic(device_id) %}
    {{ states((device_entities(device_id) | select('search','device_topic') | list)[0]) }}
    {%- endmacro %}

    {%- set ns = namespace(devices=[]) %}
    {%- for device_id in device_ids %}
      {%- set device=get_device_topic(device_id)|replace(' ','') %}
      {% set ns.devices = ns.devices + [ device ~ '/custom/' ~ app_topic] %}
    {%- endfor %}
    {{ ns.devices | reject('match','unavailable') | list}}

  #---------------------------------
  # Weather Variables
  #---------------------------------
  hourly_forecast_service: !input hourly_forecast_service_input
  current_condition: "{{states(hourly_forecast_service)}}"
  current_temp: "{{state_attr(hourly_forecast_service,'temperature')}}"

  # Forecast hours to show
  hours_displayed: !input hours_displayed_input

  #----------------
  # Temp & Text
  # --------------
  display_duration: !input display_duration_input
  current_temp_sensor: !input current_temp_sensor_input
  temp_decimals: !input temp_decimals_input
  temp_suffix: !input temp_suffix_input

  temp_text: >-
    {%- macro round_and_set_temp(temp_var, temp_suffix, digits=0) -%}
    {%- if has_value(temp_var) -%}
      {{ states(temp_var) | round(digits) ~ temp_suffix}} 
    {%- else -%}
    {{current_temp ~ temp_suffix}}
    {%- endif -%}
    {%- endmacro -%}
    {{ round_and_set_temp(current_temp_sensor, temp_suffix, temp_decimals)}}

  text_available_width: 24

  text_len: >-
    {%- macro get_text_len(string) %}
    {%- set length = namespace(value=0) %}
    {%- for char in string %}
      {%- if char.isdigit() %}
        {%- set length.value = length.value + 3 %}
      {%- elif char == '°' %}
        {%- set length.value = length.value + 2 %}
      {%- elif char == '.' %}
        {%- set length.value = length.value + 1 %}
      {%- elif char in ['-','C','F'] %}
        {%- set length.value = length.value + 3 %}
      {%- else %}
        {%- set length.value = length.value + 1 %}
      {%- endif %}
      {%- if not loop.last %}
        {%- set length.value = length.value + 1 %}{%- endif -%}
    {%- endfor -%}
    {{ length.value }}
    {%- endmacro %}

    {{get_text_len(temp_text)}}
  text_x: >-
    {{8 + ((text_available_width - text_len)/2)}}

  # ------------------------------
  # Icons&Stuff
  # ------------------------------

  icon_clear_night: !input icon_clear_night_input
  icon_cloudy: !input icon_cloudy_input
  icon_exceptional: !input icon_exceptional_input
  icon_fog: !input icon_fog_input
  icon_hail: !input icon_hail_input
  icon_lightning: !input icon_lightning_input
  icon_lightning_rainy: !input icon_lightning_rainy_input
  icon_partlycloudy: !input icon_partlycloudy_input
  icon_pouring: !input icon_pouring_input
  icon_rainy: !input icon_rainy_input
  icon_snowy: !input icon_snowy_input
  icon_snowy_rainy: !input icon_snowy_rainy_input
  icon_sunny: !input icon_sunny_input
  icon_windy: !input icon_windy_input
  icon_windy_variant: !input icon_windy_variant_input
  color_matrix_json: !input color_matrix_json_input
  temp_dict: >-
    {% set b = color_matrix_json | from_json %}    
    {%- set ns = namespace(tuples=[]) %}
    {%- for k,v in b | items -%}
      {%- set key = k|float -%}
      {%- set ns.tuples = ns.tuples + [(key,v)] %}      
    {% endfor %}
    {{ dict.from_keys(ns.tuples) }}

  icon_dict: >-
    {{ dict({'clear-night': icon_clear_night,
    'cloudy': icon_cloudy,
    'exceptional': icon_exceptional,
    'fog': icon_fog,
    'hail': icon_hail,
    'lightning': icon_lightning,
    'lightning-rainy': icon_lightning_rainy,
    'partlycloudy': icon_partlycloudy,
    'pouring': icon_pouring,
    'rainy': icon_rainy,
    'snowy': icon_snowy,
    'snowy-rainy': icon_snowy_rainy,
    'sunny': icon_sunny,
    'windy': icon_windy, 
    'windy-variant': icon_windy_variant})}}

  shortname_dict: >-
    {{ dict({
      'clear-night': "Clear",
      'cloudy': "Cloudy",
      'exceptional': "Warn", 
      'fog': "Foggy", 
      'hail': "Hail", 
      'lightning': "Storm", 
      'lightning-rainy': "Storm", 
      'partlycloudy': "P Cldy", 
      'pouring': "Rain", 
      'rainy': "Rain", 
      'snowy': "Snow", 
      'snowy-rainy': "Sleet", 
      'sunny': "Sunny", 
      'windy': "Windy", 
      'windy-variant': "Windy"}) 
    }} 

  overlay_dict: >-
    {{ dict({
      'clear-night': "clear",
      'cloudy': "clear",
      'exceptional': "clear", 
      'fog': "clear", 
      'hail': "frost", 
      'lightning': "thunder", 
      'lightning-rainy': "thunder", 
      'partlycloudy': "clear", 
      'pouring': "storm", 
      'rainy': "rain", 
      'snowy': "snow", 
      'snowy-rainy': "snow", 
      'sunny': "clear", 
      'windy': "clear", 
      'windy-variant': "clear"}) 
    }} 

  color_dict: >-
    {{ dict({
      'clear-night': "001f4d",
      'cloudy': "a0a0a0",
      'exceptional': "ff0000",
      'fog': "d3d3d3",
      'hail': "ADD8E6",
      'lightning': "a9a9a9",
      'lightning-rainy': "0000ff",
      'partlycloudy': "fdfd96",
      'pouring': "0000ff",
      'rainy': "0000ff",
      'snowy': "ffffff",
      'snowy-rainy': "ADD8E6",
      'sunny': "ffff00",
      'windy': "fdfd96",
      'windy-variant': "fdfd96"})
    }} 

  #--------------
  # Weather Icon
  #--------------
  icon: >
    {{ icon_dict[current_condition] }}
  current_condition_shortname: >
    {{ shortname_dict[current_condition] }}
  current_condition_icon: >
    {{ icon_dict[current_condition] }}
  current_condition_color: >
    {{ color_dict[current_condition] }}
  current_condition_overlay: >
    {{ overlay_dict[current_condition] }}

  # ------------------------------
  # FORECAST THINGS
  # ------------------------------


  current_condition_payload: >-
    {"icon":"{{current_condition_icon}}", "text":"{{current_condition_shortname}}", "color": "{{current_condition_color}}", "duration": {{display_duration}}}


triggers:
  - trigger: time_pattern
    minutes: !input trigger_frequency_input
  - trigger: state
    entity_id: !input hourly_forecast_service_input
    id: Changes
    enabled: true
conditions: []
actions:
  - action: weather.get_forecasts
    target:
      entity_id: "{{hourly_forecast_service}}"
    data:
      type: hourly
    response_variable: forecast_response
  - action: weather.get_forecasts
    target:
      entity_id: "{{hourly_forecast_service}}"
    data:
      type: daily
    response_variable: daily_forecast_response
  - repeat:
      for_each: "{{ topics }}"
      sequence:
        - action: mqtt.publish
          data:
            topic: "{{repeat.item}}"
            payload: >-
              {%- set forecast = forecast_response[hourly_forecast_service]['forecast'] -%}
              {%- set daily_forecast = daily_forecast_response[hourly_forecast_service]['forecast'] -%}

              {#- Define macro to interpolate color -#}
              {%- macro interpolate(dictionary, x) -%}
                {%- set sorted_keys = dictionary|dictsort -%}
                {%- set above = sorted_keys|selectattr('0', 'gt', x)|map(attribute='0')|list|first -%}
                {%- set below = sorted_keys|selectattr('0', 'lt', x)|map(attribute='0')|list|last -%}

                {#- Key matches x exactly -#}
                {%- if above is defined and dictionary[above] == x -%}
                  {%- set value = dictionary[above] -%}
                  {{ value }}
                {%- elif below is defined and dictionary[below] == x -%}
                  {%- set value = dictionary[below] -%}
                  {{ value }}
                {#- Interpolation between two values -#}
                {%- elif below is defined and above is defined -%}
                  {%- set lower_value = dictionary[below] -%}
                  {%- set upper_value = dictionary[above] -%}
                  {%- set lower_rgb = lower_value[1:] -%}
                  {%- set upper_rgb = upper_value[1:] -%}

                  {%- set lower_r = lower_rgb[0:2]|int(base=16) -%}
                  {%- set lower_g = lower_rgb[2:4]|int(base=16) -%}
                  {%- set lower_b = lower_rgb[4:6]|int(base=16) -%}

                  {%- set upper_r = upper_rgb[0:2]|int(base=16) -%}
                  {%- set upper_g = upper_rgb[2:4]|int(base=16) -%}
                  {%- set upper_b = upper_rgb[4:6]|int(base=16) -%}

                  {%- set interpolation_factor = (x - below) / (above - below) -%}
                  {%- set interpolated_r = ((1 - interpolation_factor) * lower_r + interpolation_factor * upper_r)|int -%}
                  {%- set interpolated_g = ((1 - interpolation_factor) * lower_g + interpolation_factor * upper_g)|int -%}
                  {%- set interpolated_b = ((1 - interpolation_factor) * lower_b + interpolation_factor * upper_b)|int -%}

                  {%- set interpolated_hex = '#' ~ '%02X' % interpolated_r ~ '%02X' % interpolated_g ~ '%02X' % interpolated_b -%}
                  {{ interpolated_hex }}
                {#- Only below key available -#}
                {%- elif below is defined -%}
                  {%- set value = dictionary[below] -%}
                  {{ value }}
                {#- Only above key available -#}
                {%- elif above is defined -%}
                  {%- set value = dictionary[above] -%}
                  {{ value }}
                {#- No matching keys available -#}
                {%- else -%}
                  No matching key found.
                {%- endif -%}
              {%- endmacro -%}

              {#- Define macro to get color -#}
              {%- macro get_color(dictionary, x) -%}
                {%- set sorted_keys = dictionary|dictsort -%}
                {%- set above = sorted_keys|selectattr('0', 'gt', x)|map(attribute='0')|list|first -%}
                {%- set below = sorted_keys|selectattr('0', 'le', x)|map(attribute='0')|list|last -%}

                {#- Key matches x exactly -#}
                {%- if below is defined -%}
                  {%- set value = dictionary[below] -%}
                  {{ value }}
                {%- elif above is defined -%}
                  {%- set value = dictionary[above] -%}
                  {{ value }}
                {%- else -%}
                  No matching key found.
                {%- endif -%}
              {%- endmacro -%}

              {#- Define macro to get length of the forecast -#}
              {%- macro str_len(stringo) %}
              {%- if '.' in stringo %}
              {%- set char_count = (stringo | length) -1 %}{{char_count * 3 + 1 + char_count}}
              {%- else %}
              {%- set char_count = (stringo | length) %}{{char_count * 3 + (char_count - 1)}}
              {%- endif %}
              {%- endmacro %}

              {#- Define a macro to draw out the forecast lines#}
                {%- macro draw_forecast_lines(x,hours,height) %}
                  {%- for hour in range(hours) %}
                    {%- if height == 0 %}
                      {"dp": [{{x+hour}},7,"{{get_color(temp_dict, forecast[hour]['temperature']) }}"]}
                    {%- else %}
                      {"dl": [{{x+hour}},7,{{x+hour}},{{7 - height}},"{{get_color(temp_dict, forecast[hour]['temperature']) }}"]}
                    {%- endif %}
                    {%- if hour+1 != hours %},{%endif%}
                  {%- endfor %}
                {%- endmacro %}

                {#- Define a macro to draw out the temperature range#}
                {%- macro draw_temperature_range(actual_temp, low_temp, high_temp) %}
                  {%- if high_temp == low_temp %}
                    {%- set proportion = 4 %}
                  {%- else %}
                    {%- set proportion = (actual_temp - low_temp) / (high_temp - low_temp) %}
                  {%- endif %}
                  {%- set target = (proportion * 8) | round(0, 'floor') %}
                  {%- if target < 0 %}
                    {%- set target = 0 %}
                  {%- endif %}
                  {%- if target > 7 %}
                    {%- set target = 7 %}
                  {%- endif %}
                  {%- for x in range(0, 8) %}
                    {%- if x == target %}
                      ,{"dp": [31, {{ 7 - x }}, "{{get_color(temp_dict, current_temp | float)}}"]}
                    {%- else %}
                      ,{"dp": [31, {{ 7 - x }}, "#D3D3D3"]}
                    {%- endif %}
                  {%- endfor %}
                {%- endmacro %}

                {#- Define a macro get temperature#}
                {%- macro get_temp(temp_var) -%}
                  {%- if has_value(temp_var) -%}
                    {{ states(temp_var) | round(0) }} 
                  {%- else -%}
                    {{current_temp}}
                  {%- endif -%}
                {%- endmacro -%}

                {
                  "draw": [
                    {%- if hours_displayed > 0 %}
                    {{draw_forecast_lines((20 - (hours_displayed / 2)) | round(0),hours_displayed,0)}}
                  {%- endif %}
                    {{draw_temperature_range(get_temp(current_temp_sensor) | int, daily_forecast[0]['templow'] | int, daily_forecast[0]['temperature'] | int)}}
                  {%- if current_temp != 'unavailable' -%}
                  ,{"dt":[{{text_x}},1,"{{temp_text}}","{{get_color(temp_dict, current_temp | float)}}"]}
                  {%- else -%}
                  {"dt":"err"}
                  {%- endif -%}
                  ],
                  "icon": "{{icon}}",
                  "duration": {{display_duration}},
                  "pushIcon": 2,
                  "lifetime": 120,
                  "lifetimeMode":1,
                  "weather": "{{current_condition}}"
                  }

        - action: mqtt.publish
          data:
            topic: "{{ repeat.item ~ '_weather'}} "
            payload: >
              {{current_condition_payload}}