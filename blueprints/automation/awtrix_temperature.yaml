---
blueprint:
  name: AWTRIX Temperature
  description: >
    This is a blueprint to display the temperature using the default Meteorologisk institutt (Met.no) weather integration. It may work with other weather integrations.

    This blueprint will publish to one topic for the temperature app.  It is called `awtrix_temperature` by default.

    _This blueprint may be updated with new features_

  domain: automation
  input:
    awtrix:
      name: AWTRIX Device
      description: Select the Awtrix device
      selector:
        device:
          integration: mqtt
          manufacturer: Blueforcer
          model: AWTRIX 3
          multiple: true

    forecast_var:
      name: Hourly Forecast
      description: >
        Select a sensor that provides an Hourly forecast (not a daily one)

        This has been tested with the following weather service providers:

          - HA [Meteorologisk institutt (Met.no)](https://www.home-assistant.io/integrations/met) integration 
          
      selector:
        entity:
          filter:
            domain:
              - weather
          multiple: false

    hours_to_show:
      name: Forecast Hours to Show
      description: >
        The number of hours of forecast to show along the bottom of the display
      selector:
        number:
          max: 24
          min: 0
          unit_of_measurement: "hours"
          mode: box
      default: 12

    temp_digits:
      name: Temp Digits
      description: >
        By default the temp is rounded to the nearest whole-number. Change this to 1 or 2 in order to see more decimal places.
      selector:
        number:
          min: 0
          max: 2
          step: 1
          mode: box
          unit_of_measurement: "Decimal places"
      default: 0

    temp_suffix:
      name: Temperature suffix
      description: >-
        The suffix to be displayed after the temperature
      selector:
        select:
          options:
            - label: None
              value: ""
            - label: "°"
              value: "°"
            - label: °F
              value: "°F"
            - label: °C
              value: "°C"
            - label: F
              value: "F"
            - label: C
              value: "C"
      default: "°"

    current_temp_var:
      name: Alternate Outside Temperature Sensor
      description: >
        If desired, select an alternate sensor that provides the current outside temperature you wish to display.  This can be a "Feels Like" value or a personal outdoor thermometer.
          -  `None` will use the default temperature provided by the weather service provider.
      selector:
        entity:
          domain:
            - sensor
          multiple: false
      default: sensor.weatherflow_air_temperature

    color_matrix_json:
      name: Color Matrix
      description: >
        The `Color Matrix` will control color maps to temperature ranges on the display. The format of this map is **JSON** 

        Some possible mappings are:

        #### USA: Farenheit 0-100 (Based on NOAA scale from 0-100)


            {"0": "#FEC4FF","10": "#D977DF","20": "#9545BC","30": "#4B379C","40": "#31B8DB","50": "#31DB8B","60": "#6ED228","70": "#FFFF28","80": "#F87E27","90": "#CF3927","100": "#A12527"}


        #### EURO: -12°c to  -38°c based on USA NOAA Colors 

            {"-12": "#D977DF","-6": "#9545BC","-1": "#4B379C","0": "#FEC4FF","4": "#31B8DB","10": "#31DB8B","15": "#6ED228","21": "#FFFF28","27": "#F87E27","32": "#CF3927","38": "#A12527"}

      selector:
        text:
          multiline: true
      default: >
        {
          "0": "#4B0082",
          "10": "#0000FF",
          "20": "#1E90FF",
          "30": "#87CEEB",
          "40": "#40E0D0",
          "50": "#32CD32",
          "60": "#FFFF00",
          "70": "#DAA520",
          "80": "#FFA500",
          "90": "#FF4500",
          "100": "#FF0000"
        }

    #----------------------------------------
    # Sunrise Sunset Times :)
    #----------------------------------------
    show_sun_rise_set:
      name: ☀️ Show Sunrise/Sunset
      description: >
        Prior to both sunrise and sunset times offer a message about pending sun transitional state.

                       :
              `.       ;        .'
                `.  .-'''-.   .'
                  ;'  __   _;'
                 /   '_    _`\       TURN ME ON!
                |  _( a (  a  |
            ''''| (_)    >    |``````
                 \    \    / /
                  `.   `--'.'
                 .' `-,,,-' `.
               .'      :      `.
                       :


        _You can change the icons for sun rise/set way down below._
      selector:
        boolean:
      default: True
    sun_event_minute_threshold:
      name: Sun Time Prior 🕰️
      description: >-
        This value controls when to show sunrise/set notifications. 


        If the sunrise will occur in `50` minutes and this value is set to `60` it will show, however if this value is only `30` it won't show.

      selector:
        number:
          min: 5
          max: 1440
          unit_of_measurement: "min"
      default: 30

    sun_time_type:
      name: Sun Time Type
      description: >
        When showing a notification about sun rise/set it can offer 3 different time formats:

          - Relative Time:  `12 min`
          - Actual Time:  `8:31 pm` or `22:31`
      selector:
        select:
          options:
            - Relative
            - Actual
      default: "Actual"
    sun_time_format:
      name: Actual Time Format
      description: >
        If you are using actual time you can enter a STRFTIME format string here for the time. Some options would be:

          - `%H%M` which would render `0529`
          
          - `%-I%M%p` which woudl render `529AM`
          - `%-I%:M%p` which woudl render `5:29AM`



          For details see https://strftime.org/
      selector:
        text:
          type: text
      default: "%-I%M%p"
    message_duration_forecast:
      name: Forecast Duration ⏱️
      description: >-
        How long should the forecast message remain on the screen(in seconds).  *If you select `0` it will use the Global App Time*
      selector:
        number:
          min: 0
          max: 300
          unit_of_measurement: "sec"
      default: 0

    message_duration_riseset:
      name: Sun Rise/Set Duration ⏱️
      description: >-
        How long should the sunrise sunset message remain on the screen(in seconds).  *If you select `0` it will use the Global App Time*
      selector:
        number:
          min: 0
          max: 300
          unit_of_measurement: "sec"
      default: 0

    #-----------------------------------------
    # This was really annoying to generate :)
    #-----------------------------------------
    icon_clear_night:
      name: Icon for clear-night
      description: >

        The default clear_night icon is: 

          ![](https://developer.lametric.com/content/apps/icon_thumbs/53383_icon_thumb.gif?v=2) - `53383`

      selector:
        text:
      default: "w-clear-night"

    icon_cloudy:
      name: Icon for cloudy
      description: >
        This is the icon ID which maps to the weather state: `cloudy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/53384_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-cloudy"
    icon_exceptional:
      name: Icon for exceptional
      description: >
        This is the icon ID which maps to the weather state: `exceptional`


        ![](https://developer.lametric.com/content/apps/icon_thumbs/36637_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-exceptional"
    icon_fog:
      name: Icon for fog
      description: >
        This is the icon ID which maps to the weather state: `fog`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/17055_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-fog"
    icon_hail:
      name: Icon for hail
      description: >
        This is the icon ID which maps to the weather state: `hail` (IF YOU HAVE A BETTER ONE PLEASE LET ME KNOW)

        ![](https://developer.lametric.com/content/apps/icon_thumbs/53385_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-hail"
    icon_lightning:
      name: Icon for lightning
      description: >
        This is the icon ID which maps to the weather state: `lightning`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/29839_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-lightning"
    icon_lightning_rainy:
      name: Icon for lightning-rainy
      description: >
        This is the icon ID which maps to the weather state: `lightning-rainy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/49299_icon_thumb.gif?v=4)
      selector:
        text:
      default: "w-lightning-rainy"
    icon_partlycloudy:
      name: Icon for partlycloudy
      description: >
        This is the icon ID which maps to the weather state: `partlycloudy`
         
        ![](https://developer.lametric.com/content/apps/icon_thumbs/2286_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-partlycloudy"
    icon_pouring:
      name: Icon for pouring
      description: >
        This is the default icon which maps to the weather state: `pouring`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/49300_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-pouring"
    icon_rainy:
      name: Icon for rainy
      description: >
        This is the default icon which maps to the weather state: `rainy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/2720_icon_thumb.gif?v=1)

      selector:
        text:
      default: "w-rainy"
    icon_snowy:
      name: Icon for snowy
      description: >
        This is the icon ID which maps to the weather state: `snowy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/2289_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-snowy"
    icon_snowy_rainy:
      name: Icon for snowy-rainy
      description: >
        This is the icon ID which maps to the weather state: `snowy-rainy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/49301_icon_thumb.gif?v=2)
      selector:
        text:
      default: "w-snowy-rainy"
    icon_sunny:
      name: Icon for sunny
      description: >
        This is the icon ID which maps to the weather state: `sunny`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/53386_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-sunny"
    icon_windy:
      name: Icon for windy
      description: >
        This is the icon ID which maps to the weather state: `windy`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/3363_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-windy"
    icon_windy_variant:
      name: Icon for windy-variant
      description: >
        This is the icon ID which maps to the weather state: `windy-variant`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/3363_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-windy-variant"

    icon_sunrise:
      name: Icon for sunrise
      description: >
        This is the icon ID which maps to the `sunrise`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/53418_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-sunrise"

    icon_sunset:
      name: Icon for sunset
      description: >
        This is the icon ID which maps to the `sunset`

        ![](https://developer.lametric.com/content/apps/icon_thumbs/53417_icon_thumb.gif?v=1)
      selector:
        text:
      default: "w-sunset"
mode: restart
variables:
  device_ids: !input awtrix
  app_topic: jeef_weather
  topics: >-
    {%- macro get_device_topic(device_id) %}
    {{ states((device_entities(device_id) | select('search','device_topic') | list)[0]) }}
    {%- endmacro %}

    {%- set ns = namespace(devices=[]) %}
    {%- for device_id in device_ids %}
      {%- set device=get_device_topic(device_id)|replace(' ','') %}
      {% set ns.devices = ns.devices + [ device ~ '/custom/' ~ app_topic] %}
    {%- endfor %}
    {{ ns.devices | reject('match','unavailable') | list}}

  #---------------------------------
  # Weather Variables
  #---------------------------------
  forecast_var: !input forecast_var
  current_condition: "{{states(forecast_var)}}"
  current_temp: "{{state_attr(forecast_var,'temperature')}}"

  # Forecast hours to show
  hours_to_show: !input hours_to_show

  #----------------
  # Temp & Text
  # --------------
  message_duration: !input message_duration_forecast
  message_duration_riseset: !input message_duration_riseset
  current_temp_var: !input current_temp_var
  temp_digits: !input temp_digits
  temp_suffix: !input temp_suffix

  temp_text: >-
    {%- macro round_and_set_temp(temp_var, temp_suffix, digits=0) -%}
    {%- if has_value(temp_var) -%}
      {{ states(temp_var) | round(digits) ~ temp_suffix}} 
    {%- else -%}
    {{current_temp ~ temp_suffix}}
    {%- endif -%}
    {%- endmacro -%}
    {{ round_and_set_temp(current_temp_var, temp_suffix, temp_digits)}}

  text_available_width: 24

  text_len: >-
    {%- macro get_text_len(string) %}
    {%- set length = namespace(value=0) %}
    {%- for char in string %}
      {%- if char.isdigit() %}
        {%- set length.value = length.value + 3 %}
      {%- elif char == '°' %}
        {%- set length.value = length.value + 2 %}
      {%- elif char == '.' %}
        {%- set length.value = length.value + 1 %}
      {%- elif char in ['-','C','F'] %}
        {%- set length.value = length.value + 3 %}
      {%- else %}
        {%- set length.value = length.value + 1 %}
      {%- endif %}
      {%- if not loop.last %}
        {%- set length.value = length.value + 1 %}{%- endif -%}
    {%- endfor -%}
    {{ length.value }}
    {%- endmacro %}

    {{get_text_len(temp_text)}}
  text_x: >-
    {{8 + ((text_available_width - text_len)/2)}}

  # ------------------------------
  # SUN THINGS
  # ------------------------------
  sun_event_minute_threshold: !input sun_event_minute_threshold
  sun_time_type: !input sun_time_type
  sun_time_format: !input sun_time_format
  icon_sunrise: !input icon_sunrise
  icon_sunset: !input icon_sunset
  show_sun_rise_set: !input show_sun_rise_set

  sun_next_event: >-
    {%- set rise = state_attr('sun.sun','next_rising') %}
    {%- set set = state_attr('sun.sun','next_setting') %}
    {%- set ts_rise = rise |as_timestamp %}
    {%- set ts_set = set |as_timestamp %}
    {{ iif(ts_set < ts_rise,'sunset','sunrise') }}

  sun_min_until_next_event: >-
    {%- set rise = state_attr('sun.sun','next_rising') %}
    {%- set set = state_attr('sun.sun','next_setting') %}
    {%- set ts_rise = rise |as_timestamp %}
    {%- set ts_set = set |as_timestamp %}
    {{ iif(sun_next_event == 'sunrise',(ts_rise - utcnow()|as_timestamp) / 60,(ts_set - utcnow()|as_timestamp) / 60) | round(0) }}

  sun_next_str: >-
    {%- set rise = state_attr('sun.sun','next_rising') %}
    {%- set set = state_attr('sun.sun','next_setting') %}
    {%- set ts_rise = rise |as_timestamp %}
    {%- set ts_set = set |as_timestamp %}
    {%- if sun_time_type == 'Actual' %}
      {{ iif(sun_next_event == 'sunrise',(ts_rise | as_datetime | as_local).strftime(sun_time_format),  (ts_set | as_datetime | as_local).strftime(sun_time_format)) }}
    {%- else %}
    {#- relative time #}
      {% set hours = sun_min_until_next_event // 60 %}
      {% set remaining_minutes = sun_min_until_next_event % 60 %}

      {% if hours == 0 %}
          {{ remaining_minutes }} min
      {% else %}
          [
            {"t":"{{hours}}", "c":"#ffffff"},
            {"t":"h", "c":"#9c9d97"},
            {"t":"{{remaining_minutes}}", "c":"#ffffff"},
            {"t":"m", "c":"#9c9d97"}
        ]
      {% endif %}
      
    {%- endif %}
  sun_event_icon: >-
    {{ iif(sun_next_event == 'sunrise', icon_sunrise, icon_sunset) }}
  sun_event_payload: >-
    {"icon":"{{sun_event_icon}}", "text":"{{sun_next_str}}", "duration": {{message_duration_riseset}}}
  sun_payload: >-
    {%- if show_sun_rise_set %}
    {{ iif(sun_event_minute_threshold >= sun_min_until_next_event, sun_event_payload, "{}") }}
    {%- else %}
    {}
    {%- endif %}

  # ------------------------------
  # Icons&Stuff
  # ------------------------------

  icon_clear_night: !input icon_clear_night
  icon_cloudy: !input icon_cloudy
  icon_exceptional: !input icon_exceptional
  icon_fog: !input icon_fog
  icon_hail: !input icon_hail
  icon_lightning: !input icon_lightning
  icon_lightning_rainy: !input icon_lightning_rainy
  icon_partlycloudy: !input icon_partlycloudy
  icon_pouring: !input icon_pouring
  icon_rainy: !input icon_rainy
  icon_snowy: !input icon_snowy
  icon_snowy_rainy: !input icon_snowy_rainy
  icon_sunny: !input icon_sunny
  icon_windy: !input icon_windy
  icon_windy_variant: !input icon_windy_variant
  color_matrix_json: !input color_matrix_json
  color_dict: >-
    {% set b = color_matrix_json | from_json %}    
    {%- set ns = namespace(tuples=[]) %}
    {%- for k,v in b | items -%}
      {%- set key = k|float -%}
      {%- set ns.tuples = ns.tuples + [(key,v)] %}      
    {% endfor %}
    {{ dict.from_keys(ns.tuples) }}

  icon_dict: >-
    {{ dict({'clear-night': icon_clear_night,
    'cloudy': icon_cloudy,
    'exceptional': icon_exceptional,
    'fog': icon_fog,
    'hail': icon_hail,
    'lightning': icon_lightning,
    'lightning-rainy': icon_lightning_rainy,
    'partlycloudy': icon_partlycloudy,
    'pouring': icon_pouring,
    'rainy': icon_rainy,
    'snowy': icon_snowy,
    'snowy-rainy': icon_snowy_rainy,
    'sunny': icon_sunny,
    'windy': icon_windy, 
    'windy-variant': icon_windy_variant})}}

  #--------------
  # Weather Icon
  #--------------
  icon: >
    {{ icon_dict[current_condition] }}

trigger:
  - platform: time_pattern
    seconds: /5
  - platform: state
    entity_id: !input forecast_var
    id: Changes
    enabled: true
condition: []
action:
  - service: weather.get_forecasts
    target:
      entity_id: "{{forecast_var}}"
    data:
      type: hourly
    response_variable: forecast_response

  - repeat:
      for_each: "{{ topics }}"
      sequence:
        - service: mqtt.publish
          data:
            topic: "{{repeat.item}}"
            payload: >-
              {%- set forecast = forecast_response[forecast_var]['forecast'] -%}
              {%- macro interpolate(dictionary, x) -%}
              {%- set sorted_keys = dictionary|dictsort -%}
              {%- set above = sorted_keys|selectattr('0', 'gt', x)|map(attribute='0')|list|first -%}
              {%- set below = sorted_keys|selectattr('0', 'lt', x)|map(attribute='0')|list|last -%}

              {#- Key matches x exactly -#}
              {%- if above is defined and dictionary[above] == x -%}
                {%- set value = dictionary[above] -%}
                {{ value }}
              {%- elif below is defined and dictionary[below] == x -%}
                {%- set value = dictionary[below] -%}
                {{ value }}
              {#- Interpolation between two values -#}
              {%- elif below is defined and above is defined -%}
                {%- set lower_value = dictionary[below] -%}
                {%- set upper_value = dictionary[above] -%}
                {%- set lower_rgb = lower_value[1:] -%}
                {%- set upper_rgb = upper_value[1:] -%}

                {%- set lower_r = lower_rgb[0:2]|int(base=16) -%}
                {%- set lower_g = lower_rgb[2:4]|int(base=16) -%}
                {%- set lower_b = lower_rgb[4:6]|int(base=16) -%}

                {%- set upper_r = upper_rgb[0:2]|int(base=16) -%}
                {%- set upper_g = upper_rgb[2:4]|int(base=16) -%}
                {%- set upper_b = upper_rgb[4:6]|int(base=16) -%}

                {%- set interpolation_factor = (x - below) / (above - below) -%}
                {%- set interpolated_r = ((1 - interpolation_factor) * lower_r + interpolation_factor * upper_r)|int -%}
                {%- set interpolated_g = ((1 - interpolation_factor) * lower_g + interpolation_factor * upper_g)|int -%}
                {%- set interpolated_b = ((1 - interpolation_factor) * lower_b + interpolation_factor * upper_b)|int -%}

                {%- set interpolated_hex = '#' ~ '%02X' % interpolated_r ~ '%02X' % interpolated_g ~ '%02X' % interpolated_b -%}
                {{ interpolated_hex }}
              {#- Only below key available -#}
              {%- elif below is defined -%}
                {%- set value = dictionary[below] -%}
                {{ value }}
              {#- Only above key available -#}
              {%- elif above is defined -%}
                {%- set value = dictionary[above] -%}
                {{ value }}
              {#- No matching keys available -#}
              {%- else -%}
                No matching key found.
              {%- endif -%}
              {%- endmacro -%}

              {#- Define macro to get length of the forecast -#}
              {%- macro str_len(stringo) %}
              {%- if '.' in stringo %}
              {%- set char_count = (stringo | length) -1 %}{{char_count * 3 + 1 + char_count}}
              {%- else %}
              {%- set char_count = (stringo | length) %}{{char_count * 3 + (char_count - 1)}}
              {%- endif %}
              {%- endmacro %}

              {#- Define a macro to draw out the forecast lines#}
                {%- macro draw_forecast_lines(x,hours,height) %}
                  {%- for hour in range(hours) %}
                    {%- if height == 0 %}
                      {"dp": [{{x+hour}},7,"{{interpolate(color_dict, forecast[hour]['temperature']) }}"]}
                    {%- else %}
                      {"dl": [{{x+hour}},7,{{x+hour}},{{7 - height}},"{{interpolate(color_dict, forecast[hour]['temperature']) }}"]}
                    {%- endif %}
                    {%- if hour+1 != hours %},{%endif%}
                  {%- endfor %}
                {%- endmacro %}

                {
                  "draw": [
                    {%- if hours_to_show > 0 %}
                    {{draw_forecast_lines((20 - (hours_to_show / 2)) | round(0),hours_to_show,0)}}
                  {%- endif %}
                  {%- if current_temp != 'unavailable' -%}
                  ,{"dt":[{{text_x}},1,"{{temp_text}}","{{interpolate(color_dict, current_temp | float)}}"]}
                  {%- else -%}
                  {"dt":"err"}
                  {%- endif -%}
                  ],
                  "icon": "{{icon}}",
                  "duration": {{message_duration}},
                  "pushIcon": 2,
                  "lifetime": 120,
                  "lifetimeMode":1,
                  "weather": "{{current_condition}}"
                  }

        - service: mqtt.publish
          data:
            qos: 0
            retain: false
            topic: "{{ repeat.item ~ '_sun'}} "
            payload: >
              {{sun_payload}}